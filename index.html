<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Villains - Workshop Tracker 2.0</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <!-- HTML2PDF -->
    <script src="https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js"></script>
    
    <!-- FontAwesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;700&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        display: ['Oswald', 'sans-serif'],
                    },
                    colors: {
                        villain: {
                            red: '#ff0033',
                            dark: '#0f0f0f',
                            panel: '#1a1a1a',
                            border: '#333333'
                        }
                    },
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #050505;
            background-image: 
                radial-gradient(circle at 50% 0%, rgba(255, 0, 51, 0.15), transparent 70%),
                linear-gradient(180deg, #050505 0%, #111 100%);
            min-height: 100vh;
        }

        /* Glassmorphism Classes */
        .glass-panel {
            background: rgba(26, 26, 26, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.5);
        }

        .input-dark {
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid #333;
            color: #fff;
            transition: all 0.3s ease;
        }

        .input-dark:focus {
            border-color: #ff0033;
            box-shadow: 0 0 10px rgba(255, 0, 51, 0.3);
            outline: none;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #0f0f0f; 
        }
        ::-webkit-scrollbar-thumb {
            background: #333; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #ff0033; 
        }

        /* Toast Animation */
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .toast-enter {
            animation: slideIn 0.3s ease-out forwards;
        }

        .glow-text {
            text-shadow: 0 0 15px rgba(255, 0, 51, 0.5);
        }
        
        /* PDF specific styles */
        #pdfContent {
            display: none;
        }
    </style>
</head>
<body class="text-gray-200 font-sans antialiased overflow-x-hidden selection:bg-villain-red selection:text-white">

    <!-- Toast Container -->
    <div id="toastContainer" class="fixed top-5 right-5 z-50 flex flex-col gap-3 pointer-events-none"></div>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        
        <!-- Header Section -->
        <header class="mb-10 text-center relative">
            <div class="absolute top-0 left-1/2 -translate-x-1/2 w-3/4 h-24 bg-villain-red blur-[100px] opacity-20 -z-10"></div>
            
            <h1 class="font-display text-5xl md:text-7xl font-bold tracking-wider text-white mb-2 uppercase glow-text">
                <span class="text-villain-red">‚öúÔ∏è</span> Villains <span class="text-villain-red">‚öúÔ∏è</span>
            </h1>
            <p class="text-gray-400 text-lg font-light tracking-widest uppercase">Guild Workshop Tracker</p>

            <!-- Top Controls -->
            <div class="mt-6 flex flex-wrap justify-center gap-4 items-center">
                <div id="syncIndicator" class="px-4 py-2 rounded-full bg-green-500/10 border border-green-500/30 text-green-400 text-xs font-bold uppercase tracking-wider flex items-center gap-2 transition-all">
                    <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
                    <span>Synchronizov√°no</span>
                </div>
                
                <button onclick="showInstructions()" class="px-4 py-2 rounded-lg glass-panel hover:bg-white/5 transition text-sm text-gray-300">
                    <i class="fas fa-question-circle mr-2 text-villain-red"></i> Jak to funguje?
                </button>
            </div>
        </header>

        <!-- Stats Overview -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-10">
            <!-- Stat Card 1 -->
            <div class="glass-panel rounded-2xl p-6 border-t-4 border-villain-red relative overflow-hidden group">
                <div class="absolute right-0 top-0 p-4 opacity-10 group-hover:scale-110 transition-transform">
                    <i class="fas fa-users text-6xl text-white"></i>
                </div>
                <div class="text-gray-400 text-xs uppercase tracking-widest mb-1">Celkem ƒålen≈Ø</div>
                <div class="text-4xl font-display font-bold text-white" id="totalMembers">0</div>
            </div>

            <!-- Stat Card 2 -->
            <div class="glass-panel rounded-2xl p-6 border-t-4 border-green-500 relative overflow-hidden group">
                <div class="absolute right-0 top-0 p-4 opacity-10 group-hover:scale-110 transition-transform">
                    <i class="fas fa-check-circle text-6xl text-green-500"></i>
                </div>
                <div class="text-gray-400 text-xs uppercase tracking-widest mb-1">Spl≈àuje Limit</div>
                <div class="text-4xl font-display font-bold text-green-400" id="completedCount">0</div>
            </div>

            <!-- Stat Card 3 -->
            <div class="glass-panel rounded-2xl p-6 border-t-4 border-red-600 relative overflow-hidden group">
                <div class="absolute right-0 top-0 p-4 opacity-10 group-hover:scale-110 transition-transform">
                    <i class="fas fa-exclamation-triangle text-6xl text-red-600"></i>
                </div>
                <div class="text-gray-400 text-xs uppercase tracking-widest mb-1">Nespl≈àuje</div>
                <div class="text-4xl font-display font-bold text-red-500" id="failedCount">0</div>
            </div>

            <!-- Stat Card 4 -->
            <div class="glass-panel rounded-2xl p-6 border-t-4 border-blue-500 relative overflow-hidden group">
                <div class="absolute right-0 top-0 p-4 opacity-10 group-hover:scale-110 transition-transform">
                    <i class="fas fa-chart-pie text-6xl text-blue-500"></i>
                </div>
                <div class="text-gray-400 text-xs uppercase tracking-widest mb-1">√öspƒõ≈°nost</div>
                <div class="text-4xl font-display font-bold text-blue-400" id="percentCount">0%</div>
            </div>
        </div>

        <!-- Charts Section -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-10">
            <div class="glass-panel rounded-2xl p-6">
                <h3 class="text-lg font-bold mb-4 flex items-center gap-2 text-white">
                    <i class="fas fa-chart-doughnut text-villain-red"></i> Pomƒõr Splnƒõn√≠
                </h3>
                <div class="h-64 relative">
                    <canvas id="complianceChart"></canvas>
                </div>
            </div>
            <div class="glass-panel rounded-2xl p-6">
                <h3 class="text-lg font-bold mb-4 flex items-center gap-2 text-white">
                    <i class="fas fa-chart-bar text-villain-red"></i> Distribuce D√≠len
                </h3>
                <div class="h-64 relative">
                    <canvas id="workshopChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Main Content Area -->
        <div class="glass-panel rounded-2xl overflow-hidden shadow-2xl shadow-black/50">
            
            <!-- Toolbar -->
            <div class="p-6 border-b border-white/5 flex flex-col md:flex-row justify-between items-center gap-4 bg-black/20">
                <div class="relative w-full md:w-96">
                    <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-500"></i>
                    <input type="text" id="searchInput" onkeyup="searchMember()" placeholder="Hledat hr√°ƒçe..." 
                           class="w-full bg-black/40 border border-white/10 rounded-lg pl-10 pr-4 py-2.5 text-sm text-white focus:border-villain-red focus:ring-1 focus:ring-villain-red outline-none transition-all placeholder-gray-600">
                </div>

                <div class="flex gap-2 w-full md:w-auto overflow-x-auto pb-2 md:pb-0">
                    <button onclick="openAddMemberModal()" class="flex items-center gap-2 bg-villain-red hover:bg-red-700 text-white px-5 py-2.5 rounded-lg text-sm font-bold uppercase transition-all whitespace-nowrap shadow-[0_0_15px_rgba(255,0,51,0.3)] hover:shadow-[0_0_25px_rgba(255,0,51,0.5)]">
                        <i class="fas fa-plus"></i> P≈ôidat
                    </button>
                    <button onclick="exportToPDF()" class="flex items-center gap-2 bg-white/5 hover:bg-white/10 text-white border border-white/10 px-4 py-2.5 rounded-lg text-sm font-semibold transition-all whitespace-nowrap">
                        <i class="fas fa-file-pdf text-red-400"></i> PDF
                    </button>
                    <button onclick="exportCSV()" class="flex items-center gap-2 bg-white/5 hover:bg-white/10 text-white border border-white/10 px-4 py-2.5 rounded-lg text-sm font-semibold transition-all whitespace-nowrap">
                        <i class="fas fa-file-csv text-green-400"></i> CSV
                    </button>
                    <button onclick="clearData()" class="flex items-center gap-2 bg-white/5 hover:bg-red-900/30 text-white border border-white/10 hover:border-red-500/30 px-4 py-2.5 rounded-lg text-sm font-semibold transition-all whitespace-nowrap ml-2">
                        <i class="fas fa-trash-alt text-gray-400 group-hover:text-red-500"></i> Reset
                    </button>
                </div>
            </div>

            <!-- Table -->
            <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr class="bg-black/40 text-gray-400 text-xs uppercase tracking-wider border-b border-white/5">
                            <th class="p-4 font-semibold text-center w-16">#</th>
                            <th class="p-4 font-semibold">Hr√°ƒç</th>
                            <th class="p-4 font-semibold text-center">Level</th>
                            <th class="p-4 font-semibold text-center">D√≠lna</th>
                            <th class="p-4 font-semibold text-center hidden md:table-cell">Po≈æadavek</th>
                            <th class="p-4 font-semibold text-center">Rozd√≠l</th>
                            <th class="p-4 font-semibold text-center">Stav</th>
                            <th class="p-4 font-semibold text-right">Akce</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody" class="divide-y divide-white/5 text-sm">
                        <!-- Rows rendered by JS -->
                    </tbody>
                </table>
            </div>
            
            <!-- Empty State (Hidden by default) -->
            <div id="emptyState" class="hidden py-12 text-center">
                <div class="inline-block p-4 rounded-full bg-white/5 mb-4">
                    <i class="fas fa-users-slash text-3xl text-gray-600"></i>
                </div>
                <h3 class="text-lg font-medium text-white">≈Ω√°dn√≠ ƒçlenov√©</h3>
                <p class="text-gray-500 text-sm mt-1">Seznam je pr√°zdn√Ω nebo neodpov√≠d√° vyhled√°v√°n√≠.</p>
            </div>

            <!-- Footer Legend -->
            <div class="p-4 bg-black/40 border-t border-white/5 flex flex-wrap gap-6 justify-center text-xs text-gray-500">
                <div class="flex items-center gap-2">
                    <span class="w-3 h-3 rounded-full bg-green-500/20 border border-green-500"></span>
                    <span>Spl≈àuje limit</span>
                </div>
                <div class="flex items-center gap-2">
                    <span class="w-3 h-3 rounded-full bg-red-500/20 border border-red-500"></span>
                    <span>Nespl≈àuje limit</span>
                </div>
            </div>
        </div>

        <!-- Limits Info Grid -->
        <div class="mt-10">
            <h2 class="text-xl font-display uppercase tracking-wide text-white mb-6 flex items-center gap-3">
                <i class="fas fa-list-ol text-villain-red"></i> Tabulka Po≈æadavk≈Ø
            </h2>
            <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-7 gap-3" id="limitsGrid">
                <!-- Limits rendered by JS -->
            </div>
        </div>

    </div>

    <!-- ADD MEMBER MODAL -->
    <div id="addMemberModal" class="fixed inset-0 z-[100] hidden">
        <div class="absolute inset-0 bg-black/80 backdrop-blur-sm transition-opacity" onclick="closeAddMemberModal()"></div>
        <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-full max-w-md p-6">
            <div class="glass-panel bg-[#1a1a1a] rounded-2xl border border-white/10 shadow-2xl relative">
                <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-villain-red to-transparent"></div>
                
                <h2 class="text-2xl font-display font-bold text-white mb-6 text-center">P≈ôidat ƒålena</h2>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-gray-400 text-xs uppercase font-bold mb-2 ml-1">Jm√©no</label>
                        <input type="text" id="newMemberName" placeholder="Nap≈ô. Killer123" class="w-full input-dark rounded-lg p-3">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-gray-400 text-xs uppercase font-bold mb-2 ml-1">Level</label>
                            <input type="number" id="newMemberLevel" min="1" max="600" placeholder="1-600" class="w-full input-dark rounded-lg p-3 text-center">
                        </div>
                        <div>
                            <label class="block text-gray-400 text-xs uppercase font-bold mb-2 ml-1">D√≠lna</label>
                            <input type="number" id="newMemberWorkshop" min="0" max="20" placeholder="0-20" class="w-full input-dark rounded-lg p-3 text-center">
                        </div>
                    </div>
                </div>

                <div class="flex gap-3 mt-8">
                    <button onclick="closeAddMemberModal()" class="flex-1 py-3 rounded-lg bg-gray-800 text-white font-semibold hover:bg-gray-700 transition-colors">
                        Zru≈°it
                    </button>
                    <button onclick="addNewMember()" class="flex-1 py-3 rounded-lg bg-villain-red text-white font-bold hover:bg-red-700 transition-colors shadow-lg shadow-red-900/20">
                        Potvrdit
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- PDF EXPORT TEMPLATE (Hidden) -->
    <div id="pdfContent">
        <div style="padding: 40px; background: white; font-family: 'Helvetica', sans-serif; color: #333;">
            <div style="text-align: center; margin-bottom: 30px; border-bottom: 3px solid #cc0000; padding-bottom: 20px;">
                <h1 style="color: #cc0000; font-size: 32px; margin: 0; text-transform: uppercase;">‚öúÔ∏è Villains ‚öúÔ∏è</h1>
                <p style="color: #666; font-size: 14px; margin-top: 5px;">Guild Workshop Tracker Report</p>
                <p style="color: #999; font-size: 12px; margin-top: 5px;" id="pdfDate"></p>
            </div>

            <div style="display: flex; justify-content: space-between; margin-bottom: 30px;">
                <div style="background: #f8f8f8; padding: 15px; border-radius: 8px; width: 48%;">
                    <h3 style="margin-top: 0; color: #cc0000;">Statistiky</h3>
                    <table style="width: 100%;">
                        <tr><td>Celkem ƒçlen≈Ø:</td><td style="font-weight: bold; text-align: right;" id="pdfTotalMembers">0</td></tr>
                        <tr><td>Spl≈àuje:</td><td style="font-weight: bold; color: green; text-align: right;" id="pdfCompleted">0</td></tr>
                        <tr><td>Nespl≈àuje:</td><td style="font-weight: bold; color: red; text-align: right;" id="pdfFailed">0</td></tr>
                        <tr><td>√öspƒõ≈°nost:</td><td style="font-weight: bold; text-align: right;" id="pdfPercent">0%</td></tr>
                    </table>
                </div>
                <div style="background: #f8f8f8; padding: 15px; border-radius: 8px; width: 48%;">
                    <h3 style="margin-top: 0; color: #cc0000;">Legenda</h3>
                    <p style="font-size: 12px; margin-bottom: 5px;">‚úÖ = D√≠lna spl≈àuje limit pro dan√Ω level</p>
                    <p style="font-size: 12px;">‚ùå = D√≠lna je p≈ô√≠li≈° n√≠zk√°</p>
                </div>
            </div>

            <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                <thead>
                    <tr style="background-color: #cc0000; color: white;">
                        <th style="padding: 10px; text-align: center;">#</th>
                        <th style="padding: 10px; text-align: left;">Jm√©no</th>
                        <th style="padding: 10px; text-align: center;">Level</th>
                        <th style="padding: 10px; text-align: center;">D√≠lna</th>
                        <th style="padding: 10px; text-align: center;">Po≈æadavek</th>
                        <th style="padding: 10px; text-align: center;">Rozd√≠l</th>
                        <th style="padding: 10px; text-align: center;">Stav</th>
                    </tr>
                </thead>
                <tbody id="pdfTableBody">
                    <!-- Rows -->
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // --- KONFIGURACE ---
        const workshopLimits = {
            500: 20, 450: 19, 400: 18, 350: 17, 325: 16, 300: 15, 
            275: 14, 250: 13, 230: 12, 210: 11, 190: 10, 170: 9, 
            150: 8, 101: 7
        };

        // V√Ωchoz√≠ data (pokud u≈æivatel nem√° ulo≈æen√° sv√°)
        const defaultMembers = [
            { pos: 1, name: 'Werewolf', level: 407, workshop: 0 },
            { pos: 2, name: 'Aldarion', level: 360, workshop: 0 },
            { pos: 3, name: 'Zorx', level: 341, workshop: 0 },
            { pos: 4, name: 'Rohl√≠k', level: 334, workshop: 16 },
            { pos: 5, name: 'johny', level: 323, workshop: 17 },
            { pos: 6, name: 'KOBLIH', level: 300, workshop: 0 },
            { pos: 7, name: 'Madsen', level: 298, workshop: 0 },
        ];

        let members = [];
        let chartCompliance = null;
        let chartDistribution = null;

        // --- CORE FUNCTIONS ---

        function init() {
            loadData();
            // Pokud jsou data pr√°zdn√°, pou≈æij defaultn√≠ (pro prvn√≠ spu≈°tƒõn√≠)
            if (members.length === 0 && !localStorage.getItem('villains_workshop_data_touched')) {
                members = JSON.parse(JSON.stringify(defaultMembers));
            }
            
            renderLimits();
            renderTable();

            // OPRAVA: Inicializace graf≈Ø MUS√ç b√Ωt p≈ôed updateStats, jinak jsou promƒõnn√© graf≈Ø null
            initCharts();
            updateStats();
            
            document.getElementById('pdfDate').textContent = new Date().toLocaleDateString('cs-CZ');
        }

        function loadData() {
            const saved = localStorage.getItem('villains_workshop_data');
            if (saved) {
                try {
                    members = JSON.parse(saved);
                } catch (e) {
                    console.error("Chyba p≈ôi naƒç√≠t√°n√≠ dat", e);
                    showToast('Chyba p≈ôi naƒç√≠t√°n√≠ dat', 'error');
                }
            }
        }

        function saveData() {
            localStorage.setItem('villains_workshop_data', JSON.stringify(members));
            localStorage.setItem('villains_workshop_data_touched', 'true'); // Flag ≈æe u≈æivatel upravil data
            
            // UI Feedback
            const indicator = document.getElementById('syncIndicator');
            indicator.classList.remove('text-green-400', 'bg-green-500/10', 'border-green-500/30');
            indicator.classList.add('text-yellow-400', 'bg-yellow-500/10', 'border-yellow-500/30');
            indicator.querySelector('span').textContent = 'Ukl√°d√°m...';
            indicator.querySelector('.w-2').classList.replace('bg-green-500', 'bg-yellow-500');

            setTimeout(() => {
                indicator.classList.add('text-green-400', 'bg-green-500/10', 'border-green-500/30');
                indicator.classList.remove('text-yellow-400', 'bg-yellow-500/10', 'border-yellow-500/30');
                indicator.querySelector('span').textContent = 'Synchronizov√°no';
                indicator.querySelector('.w-2').classList.replace('bg-yellow-500', 'bg-green-500');
            }, 600);
        }

        function getRequirement(level) {
            for (const [limit, req] of Object.entries(workshopLimits).sort((a, b) => b[0] - a[0])) {
                if (level >= parseInt(limit)) return req;
            }
            return 0;
        }

        // --- RENDER FUNCTIONS ---

        function renderLimits() {
            const grid = document.getElementById('limitsGrid');
            grid.innerHTML = '';
            
            Object.entries(workshopLimits)
                .sort((a, b) => b[0] - a[0])
                .forEach(([level, req]) => {
                    const el = document.createElement('div');
                    el.className = 'glass-panel p-3 rounded-lg text-center border-t-2 border-villain-red flex flex-col items-center justify-center';
                    el.innerHTML = `
                        <div class="text-xs text-gray-500 uppercase font-bold">Lvl ${level}+</div>
                        <div class="text-xl font-bold text-white mt-1">${req}</div>
                        <div class="text-[10px] text-gray-600">d√≠lna</div>
                    `;
                    grid.appendChild(el);
                });
        }

        function renderTable() {
            const tbody = document.getElementById('tableBody');
            const pdfBody = document.getElementById('pdfTableBody');
            const search = document.getElementById('searchInput').value.toLowerCase();
            
            tbody.innerHTML = '';
            pdfBody.innerHTML = '';

            const filteredMembers = members.filter(m => m.name.toLowerCase().includes(search));
            
            // Sort by level desc
            filteredMembers.sort((a, b) => b.level - a.level);

            if (filteredMembers.length === 0) {
                document.getElementById('emptyState').classList.remove('hidden');
            } else {
                document.getElementById('emptyState').classList.add('hidden');
            }

            filteredMembers.forEach((m, index) => {
                const req = getRequirement(m.level);
                const diff = m.workshop - req;
                const isMet = diff >= 0;
                
                // Color Logic
                const diffColor = diff >= 0 ? 'text-green-400' : 'text-villain-red';
                const rowClass = 'hover:bg-white/5 transition-colors group';

                // --- MAIN HTML TABLE ROW ---
                const tr = document.createElement('tr');
                tr.className = rowClass;
                tr.innerHTML = `
                    <td class="p-4 text-center text-gray-500 font-mono text-xs">#${index + 1}</td>
                    
                    <td class="p-4">
                        <input type="text" value="${m.name}" 
                            class="bg-transparent border-b border-transparent focus:border-villain-red focus:bg-black/20 text-white font-semibold w-full outline-none transition-colors px-1 py-1"
                            onchange="updateMemberData(${m.pos}, 'name', this.value)">
                    </td>
                    
                    <td class="p-4 text-center">
                        <input type="number" value="${m.level}" min="1" max="600"
                            class="bg-transparent border border-white/10 rounded px-2 py-1 text-center w-20 text-sm focus:border-villain-red focus:bg-black/20 outline-none transition-all"
                            onchange="updateMemberData(${m.pos}, 'level', this.value)">
                    </td>
                    
                    <td class="p-4 text-center">
                        <div class="flex items-center justify-center gap-2">
                            <button onclick="adjustWorkshop(${m.pos}, -1)" class="w-6 h-6 rounded bg-white/5 hover:bg-villain-red hover:text-white text-gray-400 transition flex items-center justify-center text-xs opacity-0 group-hover:opacity-100">-</button>
                            <input type="number" value="${m.workshop}" min="0" max="20"
                                class="bg-black/30 border ${isMet ? 'border-green-500/30' : 'border-red-500/30'} rounded px-2 py-1 text-center w-16 text-white font-bold outline-none focus:border-villain-red transition-all"
                                onchange="updateMemberData(${m.pos}, 'workshop', this.value)">
                            <button onclick="adjustWorkshop(${m.pos}, 1)" class="w-6 h-6 rounded bg-white/5 hover:bg-green-500 hover:text-white text-gray-400 transition flex items-center justify-center text-xs opacity-0 group-hover:opacity-100">+</button>
                        </div>
                    </td>
                    
                    <td class="p-4 text-center text-gray-500 hidden md:table-cell">
                        <span class="px-2 py-1 rounded bg-white/5 text-xs">min. ${req}</span>
                    </td>
                    
                    <td class="p-4 text-center font-mono font-bold ${diffColor}">
                        ${diff > 0 ? '+' + diff : diff}
                    </td>
                    
                    <td class="p-4 text-center">
                        <span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-medium ${isMet ? 'bg-green-500/10 text-green-400 border border-green-500/20' : 'bg-red-500/10 text-red-500 border border-red-500/20'}">
                            ${isMet ? '<i class="fas fa-check"></i> OK' : '<i class="fas fa-times"></i> FAIL'}
                        </span>
                    </td>
                    
                    <td class="p-4 text-right">
                        <button onclick="deleteMember(${m.pos})" class="text-gray-600 hover:text-red-500 transition-colors p-2" title="Odstranit">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);

                // --- PDF TABLE ROW ---
                const pdfTr = document.createElement('tr');
                pdfTr.innerHTML = `
                    <td style="padding: 8px; border-bottom: 1px solid #eee; text-align: center;">${index + 1}</td>
                    <td style="padding: 8px; border-bottom: 1px solid #eee; font-weight: bold;">${m.name}</td>
                    <td style="padding: 8px; border-bottom: 1px solid #eee; text-align: center;">${m.level}</td>
                    <td style="padding: 8px; border-bottom: 1px solid #eee; text-align: center;">${m.workshop}</td>
                    <td style="padding: 8px; border-bottom: 1px solid #eee; text-align: center; color: #666;">${req}</td>
                    <td style="padding: 8px; border-bottom: 1px solid #eee; text-align: center; font-weight: bold; color: ${diff >= 0 ? 'green' : 'red'};">${diff > 0 ? '+' + diff : diff}</td>
                    <td style="padding: 8px; border-bottom: 1px solid #eee; text-align: center;">${isMet ? '<span style="color:green">‚úî</span>' : '<span style="color:red">‚úò</span>'}</td>
                `;
                pdfBody.appendChild(pdfTr);
            });
        }

        function updateStats() {
            const total = members.length;
            const completed = members.filter(m => (m.workshop - getRequirement(m.level)) >= 0).length;
            const failed = total - completed;
            const percent = total > 0 ? Math.round((completed / total) * 100) : 0;

            // DOM Animation for numbers
            animateValue("totalMembers", parseInt(document.getElementById("totalMembers").innerText), total, 500);
            animateValue("completedCount", parseInt(document.getElementById("completedCount").innerText), completed, 500);
            animateValue("failedCount", parseInt(document.getElementById("failedCount").innerText), failed, 500);
            document.getElementById("percentCount").innerText = percent + "%";

            // PDF Stats
            document.getElementById("pdfTotalMembers").innerText = total;
            document.getElementById("pdfCompleted").innerText = completed;
            document.getElementById("pdfFailed").innerText = failed;
            document.getElementById("pdfPercent").innerText = percent + "%";

            updateCharts(completed, failed, members);
        }

        function animateValue(id, start, end, duration) {
            if (start === end) return;
            const range = end - start;
            let current = start;
            const increment = end > start ? 1 : -1;
            const stepTime = Math.abs(Math.floor(duration / range));
            const obj = document.getElementById(id);
            const timer = setInterval(function() {
                current += increment;
                obj.innerHTML = current;
                if (current == end) {
                    clearInterval(timer);
                }
            }, Math.max(stepTime, 10)); // Min 10ms
        }

        // --- DATA MANIPULATION ---

        function updateMemberData(pos, field, value) {
            const member = members.find(m => m.pos === pos);
            if (!member) return;

            let finalValue = value;
            if (field === 'level' || field === 'workshop') {
                finalValue = parseInt(value) || 0;
            } else {
                finalValue = value.trim();
            }

            member[field] = finalValue;
            
            // Debounced rendering to avoid flickering on typing
            clearTimeout(window.updateTimer);
            window.updateTimer = setTimeout(() => {
                saveData();
                renderTable(); // Re-sorts automatically
                updateStats();
            }, 500);
        }

        function adjustWorkshop(pos, amount) {
            const member = members.find(m => m.pos === pos);
            if (member) {
                let newVal = member.workshop + amount;
                if (newVal < 0) newVal = 0;
                if (newVal > 20) newVal = 20;
                member.workshop = newVal;
                saveData();
                renderTable();
                updateStats();
            }
        }

        function deleteMember(pos) {
            const member = members.find(m => m.pos === pos);
            if (member && confirm(`Opravdu smazat hr√°ƒçe ${member.name}?`)) {
                members = members.filter(m => m.pos !== pos);
                saveData();
                renderTable();
                updateStats();
                showToast(`Hr√°ƒç ${member.name} odstranƒõn`, 'info');
            }
        }

        function openAddMemberModal() {
            document.getElementById('addMemberModal').classList.remove('hidden');
            document.getElementById('newMemberName').focus();
        }

        function closeAddMemberModal() {
            document.getElementById('addMemberModal').classList.add('hidden');
            // Clear inputs
            document.getElementById('newMemberName').value = '';
            document.getElementById('newMemberLevel').value = '';
            document.getElementById('newMemberWorkshop').value = '';
        }

        function addNewMember() {
            const name = document.getElementById('newMemberName').value.trim();
            const lvl = parseInt(document.getElementById('newMemberLevel').value);
            const work = parseInt(document.getElementById('newMemberWorkshop').value) || 0;

            if (!name) return showToast('Zadej jm√©no!', 'error');
            if (!lvl) return showToast('Zadej level!', 'error');

            const newPos = Date.now(); // Unique ID using timestamp
            members.push({ pos: newPos, name: name, level: lvl, workshop: work });
            
            saveData();
            renderTable();
            updateStats();
            closeAddMemberModal();
            showToast(`Hr√°ƒç ${name} p≈ôid√°n!`, 'success');
        }

        function clearData() {
            if(confirm("OPRAVDU SMAZAT V≈†ECHNA DATA? Tato akce je nevratn√°.")) {
                members = [];
                saveData();
                renderTable();
                updateStats();
                showToast('Datab√°ze vymaz√°na', 'info');
            }
        }

        function searchMember() {
            renderTable();
        }

        // --- CHARTS ---

        function initCharts() {
            // Doughnut Chart
            const ctx1 = document.getElementById('complianceChart').getContext('2d');
            chartCompliance = new Chart(ctx1, {
                type: 'doughnut',
                data: {
                    labels: ['Splnƒõno', 'Nesplnƒõno'],
                    datasets: [{
                        data: [0, 0],
                        backgroundColor: ['#22c55e', '#ef4444'],
                        borderWidth: 0,
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom', labels: { color: '#9ca3af', font: {family: 'Inter'} } }
                    },
                    cutout: '70%'
                }
            });

            // Bar Chart
            const ctx2 = document.getElementById('workshopChart').getContext('2d');
            chartDistribution = new Chart(ctx2, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Hr√°ƒçi',
                        data: [],
                        backgroundColor: '#ff0033',
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { 
                            beginAtZero: true, 
                            grid: { color: 'rgba(255,255,255,0.05)' },
                            ticks: { color: '#6b7280', stepSize: 1 } 
                        },
                        x: { 
                            grid: { display: false },
                            ticks: { color: '#6b7280' } 
                        }
                    },
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }

        function updateCharts(completed, failed, allMembers) {
            // Update Doughnut
            if (chartCompliance) {
                chartCompliance.data.datasets[0].data = [completed, failed];
                chartCompliance.update();
            }

            // Update Bar Chart (Histogram of Workshop levels)
            if (chartDistribution) {
                const levels = {};
                for(let i=0; i<=20; i++) levels[i] = 0; // Init all levels
                
                allMembers.forEach(m => {
                    const w = m.workshop || 0;
                    if (levels[w] !== undefined) levels[w]++;
                });

                // Filter out empty levels from visualization to keep it clean, or keep range
                // Let's show only active ranges
                const labels = Object.keys(levels).filter(k => levels[k] > 0);
                const data = labels.map(k => levels[k]);

                chartDistribution.data.labels = labels.map(l => `Lvl ${l}`);
                chartDistribution.data.datasets[0].data = data;
                chartDistribution.update();
            }
        }

        // --- UTILS ---

        function showToast(msg, type = 'success') {
            const container = document.getElementById('toastContainer');
            const el = document.createElement('div');
            
            let colors = type === 'success' ? 'border-green-500 text-green-400 bg-gray-900' : 
                         type === 'error' ? 'border-red-500 text-red-400 bg-gray-900' : 
                         'border-blue-500 text-blue-400 bg-gray-900';

            el.className = `glass-panel pointer-events-auto flex items-center gap-3 px-4 py-3 rounded-lg border-l-4 shadow-lg toast-enter ${colors}`;
            el.innerHTML = `
                <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle'}"></i>
                <span class="font-semibold text-sm">${msg}</span>
            `;

            container.appendChild(el);

            setTimeout(() => {
                el.style.opacity = '0';
                el.style.transform = 'translateX(100%)';
                el.style.transition = 'all 0.3s ease';
                setTimeout(() => el.remove(), 300);
            }, 3000);
        }

        function exportToPDF() {
            showToast('Generuji PDF...', 'info');
            const element = document.getElementById('pdfContent');
            element.style.display = 'block'; // Temporarily show for render
            
            const opt = {
                margin: 10,
                filename: 'Villains_Workshop_Tracker.pdf',
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };

            html2pdf().set(opt).from(element).save().then(() => {
                element.style.display = 'none';
                showToast('PDF sta≈æeno!', 'success');
            });
        }

        function exportCSV() {
            let csv = 'Po≈ôad√≠,Jm√©no,Level,D√≠lna,Po≈æadavek,Rozd√≠l,Stav\n';
            members.forEach((m, index) => {
                const req = getRequirement(m.level);
                const diff = m.workshop - req;
                const status = diff >= 0 ? 'OK' : 'FAIL';
                csv += `${index+1},"${m.name}",${m.level},${m.workshop},${req},${diff},${status}\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'villains_workshop_export.csv';
            link.click();
            showToast('CSV sta≈æeno!', 'success');
        }

        function showInstructions() {
            alert("üõ† JAK TO FUNGUJE:\n\n1. Tabulka automaticky poƒç√≠t√°, jakou d√≠lnu by mƒõl hr√°ƒç m√≠t vzhledem ke sv√©mu levelu.\n2. ƒåerven√° ƒç√≠sla znamenaj√≠, ≈æe hr√°ƒç nespl≈àuje limit.\n3. Data se automaticky ukl√°daj√≠ do prohl√≠≈æeƒçe.\n4. M≈Ø≈æe≈° kliknout p≈ô√≠mo do tabulky a upravit hodnoty.");
        }

        // Init
        window.addEventListener('DOMContentLoaded', init);

    </script>
</body>
</html>
